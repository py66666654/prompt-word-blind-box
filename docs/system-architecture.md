# 提示词盲盒系统架构

## 技术栈概述

提示词盲盒应用采用现代Web开发技术栈，构建稳定、高效且易于扩展的系统架构。

### 前端技术

- **HTML5**：提供应用的结构和内容
- **CSS3**：负责应用的样式和动画效果
- **JavaScript (原生)**：实现前端交互逻辑，无需额外框架
- **LocalStorage**：本地存储用户认证状态和基本信息
- **Fetch API**：处理与后端的HTTP通信

### 后端技术

- **Node.js**：JavaScript运行时环境
- **Express.js**：Web应用框架，处理HTTP请求和路由
- **MySQL**：关系型数据库，存储应用数据
- **WebSocket**：实现实时通知和实时功能
- **JWT (JSON Web Token)**：用户认证和授权
- **bcrypt**：密码哈希和安全存储
- **nodemailer**：邮件发送功能，用于用户验证和密码重置

### 开发与部署工具

- **nodemon**：开发环境自动重启服务
- **dotenv**：环境变量管理
- **cors**：跨域资源共享中间件

## 系统架构图

```
┌─────────────────────────────┐      ┌─────────────────────────────┐
│        客户端 (浏览器)        │      │            服务器           │
│                             │      │                             │
│  ┌─────────────────────┐    │      │  ┌─────────────────────┐    │
│  │      前端页面        │    │      │  │   Express.js 服务    │    │
│  │                     │    │      │  │                     │    │
│  │  - HTML/CSS         │    │      │  │  - API 路由          │    │
│  │  - JavaScript       │◄───┼──────┼──►  - 中间件            │    │
│  │  - 盲盒抽卡界面      │    │ HTTP │  │  - 控制器            │    │
│  │  - 用户认证界面      │    │      │  │  - 服务              │    │
│  │  - 收藏管理          │    │      │  │                     │    │
│  └─────────────────────┘    │      │  └─────────┬───────────┘    │
│                             │      │            │                │
│  ┌─────────────────────┐    │      │  ┌─────────▼───────────┐    │
│  │ WebSocket 客户端     │    │      │  │      数据库模块      │    │
│  │                     │◄───┼──────┼──►                     │    │
│  │  - 实时通知          │  WS  │    │  │  - 连接池管理        │    │
│  │  - 活动更新          │      │    │  │  - 查询处理          │    │
│  └─────────────────────┘    │      │  │                     │    │
│                             │      │  └─────────┬───────────┘    │
└─────────────────────────────┘      │            │                │
                                     │  ┌─────────▼───────────┐    │
                                     │  │       MySQL         │    │
                                     │  │                     │    │
                                     │  │  - 用户数据          │    │
                                     │  │  - 提示词卡片        │    │
                                     │  │  - 收藏记录          │    │
                                     │  │  - 社交互动数据      │    │
                                     │  │  - 成就与挑战        │    │
                                     │  └─────────────────────┘    │
                                     │                             │
                                     └─────────────────────────────┘
```

## 模块组织

### 前端模块

1. **核心模块**
   - `public/index.html`：主页面结构
   - `public/styles.css`：样式定义
   - `public/script.js`：主脚本，包含盲盒抽卡逻辑

2. **API通信模块**
   - `public/api.js`：封装后端API通信
   - `public/config.js`：API配置和常量

3. **用户认证模块**
   - `public/auth.js`：处理用户注册、登录和认证状态

### 后端模块

1. **核心模块**
   - `server.js`：应用入口点
   - `config/database.js`：数据库配置
   - `routes/index.js`：路由总入口

2. **API路由模块**
   - `routes/prompt.routes.updated.js`：提示词相关路由
   - `routes/user.routes.js`：用户相关路由
   - `routes/collection.routes.js`：收藏相关路由
   - 其他功能模块路由...

3. **控制器模块**
   - `controllers/prompt.controller.updated.js`：提示词逻辑处理
   - `controllers/user.controller.js`：用户逻辑处理
   - 其他功能控制器...

4. **服务模块**
   - `services/ai-prompt-generator.js`：AI提示词生成
   - `services/content-filter.service.js`：内容过滤
   - `services/websocket.service.js`：WebSocket服务
   - 其他业务服务...

5. **中间件模块**
   - `middlewares/auth.middleware.js`：认证中间件
   - `middlewares/websocket.middleware.js`：WebSocket中间件

## 数据流程

### 用户抽取提示词流程

1. 用户点击"抽取卡片"按钮
2. 前端发送请求到 `/api/prompts/random`
3. 后端控制器执行以下步骤：
   - 随机决定是否使用AI生成提示词(50%概率)
   - 基于权重随机选择稀有度
   - 从选定稀有度中随机选择一个提示词
4. 返回提示词数据到前端
5. 前端显示盲盒开启动画
6. 显示抽取的提示词卡片

### 用户认证流程

1. 用户提交登录表单
2. 前端发送请求到 `/api/users/login`
3. 后端验证用户凭据
4. 生成JWT令牌并返回给前端
5. 前端存储令牌到LocalStorage
6. 使用令牌进行后续受保护API请求

### 提示词收藏流程

1. 用户点击提示词卡片上的"收藏"按钮
2. 前端发送请求到 `/api/collections/{promptId}`
3. 后端验证用户认证并记录收藏
4. 更新用户收藏数据和相关统计
5. 返回成功消息给前端
6. 前端显示成功通知

## 安全措施

1. **用户认证**
   - 使用JWT进行API认证
   - 密码使用bcrypt哈希存储
   - 令牌过期机制

2. **输入验证**
   - 服务器端验证所有输入
   - 防止SQL注入攻击

3. **内容过滤**
   - 自动过滤不适当内容
   - 内容举报机制

4. **CORS配置**
   - 适当配置跨域资源共享
   - 限制API访问来源

## 扩展性设计

系统设计考虑了未来的扩展需求：

1. **模块化架构**
   - 各功能模块独立封装
   - 易于添加新功能模块

2. **数据库设计**
   - 规范化表结构
   - 支持未来数据增长

3. **API版本控制**
   - 可以引入API版本控制
   - 支持向后兼容

4. **服务分离**
   - 核心业务逻辑封装为服务
   - 可以迁移到微服务架构

## 性能优化

1. **数据库优化**
   - 使用连接池管理数据库连接
   - 关键字段添加索引

2. **缓存策略**
   - 可以引入Redis缓存常用数据
   - 减少数据库查询

3. **前端优化**
   - 最小化HTTP请求
   - 图片懒加载

4. **负载均衡**
   - 设计支持水平扩展
   - 可以部署多个服务器实例